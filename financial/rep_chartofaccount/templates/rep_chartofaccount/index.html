{% extends 'base-form.html' %}
{% block page-title %} Report - Chart of Account {% endblock page-title %}
{% block extra_css %}
    {% load static %}
    <link rel="stylesheet" href="{% static 'financial-layout/assets/plugin/bootstrap-datepicker/css/bootstrap-datepicker.min.css' %}" />
{% endblock extra_css %}
{% block page-content %}
<div class="panel">
    <div class="panel-body container-fluid">
        <div class="row">
            <div class="col-md-12">
                <div class="page-wrap">
                    <!-- Start Basic Table Section -->
                    <h4><p>Report List</p></h4>
                    <div class="text-left">
                        <div class="row col-md-2">
                            <input type="text" class="form-control date-yyyymmdd datepickerfrom" name="date_from" placeholder="From">
                        </div>
                        <div class="row col-md-2" style="margin-left:5px">
                            <input type="text" class="form-control date-yyyymmdd datepickerto" name="date_to" placeholder="To">
                        </div>
                        <div class="row col-md-2" style="margin-left:20px">
                            <button id="generate" class="btn btn-info">Generate</button>
                        </div>
                    </div>
                    <div class="text-right">
                        <a href="{% url 'rep_chartofaccount:pdf' %}?from=none&to=none" target="_blank" id="generate_pdf"><button type="button" class="btn btn-info btn-sm waves-effect waves-light">
                            <i class="icon fa-file-pdf-o" aria-hidden="true"></i>&nbsp; PDF
                        </button></a>
                        <a href="{% url 'rep_chartofaccount:xls' %}?from=none&to=none" target="_blank" id="generate_xls"><button type="button" class="btn btn-info btn-sm waves-effect waves-light">
                            <i class="icon fa-file-excel-o" aria-hidden="true"></i>&nbsp; XLS
                        </button></a>
                        <br><br>
                    </div>

                    <div class="table-responsive" style="position: relative">
                        <div id="shade"><div class="loader two-color"></div></div>
                        <table class="table table-hover table-bordered">
                            <thead>
                                <tr>
                                    <th><span>Account Code</span></th>
                                    <th><span>Title</span></th>
                                    <th><span>Description</span></th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="clearfix"></div>
        </div>
    </div>
</div>
{% endblock page-content %}
{% block extra_js %}
    <script src="{% static 'financial-layout/assets/plugin/bootstrap-datepicker/js/bootstrap-datepicker.min.js' %}"></script>
    <script src="{% static 'financial-layout/assets/plugin/bootstrap-datepicker/js/custom-datepicker.js' %}"></script>
<script type="text/javascript">
$(function(){
    var from, to, regEx, newurl;
    var pdf_link, xls_link;
    var tableList = $('table tbody');

    $(document).on('click', '#generate', function() {
        generateReport();
    });

    function generateReport(){
        from = $('.datepickerfrom').val();
        to = $('.datepickerto').val();

        tableList.html('');
        $('#shade').fadeIn();
        $.ajax({
            url: "{% url 'rep_chartofaccount:report' %}",
            type: "post",
            data: {'from': from, 'to': to},
            success: function(response) {

                if(response.list_chartofaccount != "[]"){
                    var list_chartofaccount = jQuery.parseJSON(response.list_chartofaccount);
                    console.debug(list_chartofaccount);

                    for (var i = 0; i < list_chartofaccount.length; i++) {
                        console.log(1)
                        tableList.append("<tr><td>" + list_chartofaccount[i].fields['accountcode'] + "</td></tr>");

                        tableList.find('tr').eq(i).last('td').append("<td>" + list_chartofaccount[i].fields['title'] + "</td>");
                        tableList.find('tr').eq(i).last('td').append("<td>" + list_chartofaccount[i].fields['description'] + "</td>");

                        $('#shade').fadeOut();
                    }
                }
                else{
                    tableList.append("<tr><td colspan='3'> No result found </td></tr>");
                    $('#shade').fadeOut();
                }
            }
            ,error: function(response) {
                console.debug(response);
                tableList.html('');
                tableList.append("<tr><td colspan='3> No result found </td></tr>");
                $('#shade').fadeOut();
            }
        });

        changeLink(from, to)
    }

    function changeLink(from, to){
        pdf_link = $('#generate_pdf').attr('href');
        regEx = /([?&]from)=([^#&]*)/g;
        newurl = pdf_link.replace(regEx, '$1='+from);
        $('#generate_pdf').attr('href', newurl);

        pdf_link = $('#generate_pdf').attr('href');
        regEx = /([?&]to)=([^#&]*)/g;
        newurl = pdf_link.replace(regEx, '$1='+to);
        $('#generate_pdf').attr('href', newurl);

        xls_link = $('#generate_xls').attr('href');
        regEx = /([?&]from)=([^#&]*)/g;
        newurl = xls_link.replace(regEx, '$1='+from);
        $('#generate_xls').attr('href', newurl);

        xls_link = $('#generate_xls').attr('href');
        regEx = /([?&]to)=([^#&]*)/g;
        newurl = xls_link.replace(regEx, '$1='+to);
        $('#generate_xls').attr('href', newurl);
    }
});
</script>
{% endblock extra_js %}
