<form class="form-horizontal" id="detailform" method="get" action="">
{% csrf_token %}
    <div class="row">
        <label style="display: none;" id="itemno">1</label>
        <div class="col-lg-12 form-group">
            <label class="col-sm-3 control-label" for="item_name">Item</label>
            <div class="col-sm-7">
                <select class="form-control input-sm select2" required style="width: 100%" id="id_item_name" name="item_name">
                    <option value="">-- Select Item --</option>
                    {% for invitem in invitem %}
                        <option value="{{ invitem.id }}" data-itemtype="{{ invitem.inventoryitemclass.inventoryitemtype.id }}">{{ invitem.description }} ({{ invitem.unitofmeasure.code }})</option>
                    {% endfor %}
                </select>
                <span class="help-block form-error">{{ form.item_name.errors.as_text }}</span>
            </div>
            <label class="col-sm-3 control-label" for="quantity">Quantity</label>
            <div class="col-sm-3">
                <input type="number" class="form-control input-sm" id="id_quantity" name="quantity">
                <span class="help-block form-error">{{ form.quantity.errors.as_text }}</span>
            </div>
        </div>
        <div class="col-sm-12 pull-left margin-bottom-10">
            <button type="button" class="btn btn-round btn-dark waves-effect waves-light" id="btn_detailsubmit">Add Item</button>
            <button type="button" class="btn btn-round btn-dark waves-effect waves-light" id="btn_detailclose">Close</button>
        </div>
    </div>
</form>
<script type="text/javascript">
    $(document).ready(function() {
        summary = $("#summary tbody");
        separateRadio();

        $(document).on('click', '#importconfirm', function(){
            $('.shade').fadeIn();
            $.ajax({
                url: "{% url 'canvasssheet:importitems' %}",
                type: "post",
                data: {'prfnum': $("#importrfselect2").val(),
                        'secretkey': $("#id_secretkey").val()
                },

                success: function(response) {
                    if(response.prfdata != "[]"){
                        $("#prfcontainer").append("<div class='widgett widgett-article widgett-shadow'>" +
                                                    "<div class='widgett-header cover padding-0 bg-grey-600'>" +
                                                    "<div class='background-cover padding-10'>PRF - " +
                                                        response.prfdata[0] +
                                                    "<button type='button' class='close removeprf' data-prf='" + response.prfdata[0] + "'>" +
                                                        "<i class='icon fa-close' aria-hidden='true'></i>" +
                                                    "</button>" +
                                                    "</div></div></div>");

                        for (var i = 0; i < response.prfdetail.length; i++) {

                            if($("tr#" + response.prfdetail[i][4]).length > 0){
                                item_total = parseInt($("tr#" + response.prfdetail[i][4] + " .item_quantity").find('.item_quantity_input').val()) + parseInt(response.prfdetail[i][3]);
                                $("tr#" + response.prfdetail[i][4] + " .item_quantity").find('.item_quantity_input').val(item_total);
                                temp_supplier = filterSupplier(response.prfdetail[i][0], response.prfsupplier);
                            }
                            else{
                                $("#itemno").text(parseInt($("#itemno").text()) + 1);

                                temp_supplier = filterSupplier(response.prfdetail[i][0], response.prfsupplier);
                                temp_supplier_length = temp_supplier.length;

                                summary.append("<tr id='" + response.prfdetail[i][4] + "' class='item_container'> " +
                                            "<td class='small' rowspan='" + temp_supplier_length + "' style='width: 40px'></td>" +
                                            "<td class='small' rowspan='" + temp_supplier_length + "'><a href='#'><i class='icon fa-trash' aria-hidden='true'></i></a> &nbsp;&nbsp;" + response.prfdetail[i][0] + "</td>" +
                                            "<td class='small' rowspan='" + temp_supplier_length + "'>" + response.prfdetail[i][1] + "</td>" +
                                            "<td class='small item_quantity text-center' rowspan='" + temp_supplier_length + "' align='center'>" +
                                                "<input type='number' class='form-control input-sm item_quantity_input' style='margin:auto; width: 70px;' data-item='" + response.prfdetail[i][4] + "' value='" + response.prfdetail[i][3] + "'>" +
                                            "</td>" +
                                            "</tr>");

                                for(var j = 0; j < temp_supplier_length; j++) {
                                    // delete form temp on delete
                                    // on delete item
                                    // hover view more details about supplier

                                    if(j==0){
                                        summary.find('tr').last().append("<td><input type='radio' name='supplier' class='radio radio-custom supplier' data-item='" + response.prfdetail[i][4] + "' data-supplier='" + temp_supplier[j][10] + "' form='" + i + "'></td>" +
                                                "<td class='small'>" + temp_supplier[j][5] + "</td> " +
                                                "<td class='small text-right' style='padding-right: 30px'>" + temp_supplier[j][2] + "</td> " +
                                                "<td class='small'><input type='number' class='form-control item_cost input-sm' value='" + temp_supplier[j][2] + "'></td> " +
                                                "<td class='small item_amount text-right'></td>" +
                                                "<td class='small item_vat_rate text-center' data-vatcode='" + temp_supplier[j][8] + "'>" + temp_supplier[j][7] + "</td>" +
                                                "<td class='small item_vatable text-right'></td>" +
                                                "<td class='small item_vatexempt text-right'></td>" +
                                                "<td class='small item_vatzero text-right'></td>" +
                                                "<td class='small item_totalpurchase text-right'></td>" +
                                                "<td class='small item_addvat text-right'></td>" +
                                                "<td class='small item_total_amount text-right'></td>"
                                                );
                                    }
                                    else{
                                        summary.append("<tr>" +
                                                "<td><input type='radio' name='supplier' class='radio radio-custom supplier' data-item='" + response.prfdetail[i][4] + "' data-supplier='" + temp_supplier[j][10] + "' form='" + i + "'></td> " +
                                                "<td class='small'>" + temp_supplier[j][5] + "</td> " +
                                                "<td class='small text-right' style='padding-right: 30px'>" + temp_supplier[j][2] + "</td> " +
                                                "<td class='small'><input type='number' class='form-control item_cost input-sm' value='" + temp_supplier[j][2] + "'></td> " +
                                                "<td class='small item_amount text-right'></td>" +
                                                "<td class='small item_vat_rate text-center' data-vatcode='" + temp_supplier[j][8] + "'>" + temp_supplier[j][7] + "</td>" +
                                                "<td class='small item_vatable text-right'></td>" +
                                                "<td class='small item_vatexempt text-right'></td>" +
                                                "<td class='small item_vatzero text-right'></td>" +
                                                "<td class='small item_totalpurchase text-right'></td>" +
                                                "<td class='small item_addvat text-right'></td>" +
                                                "<td class='small item_total_amount text-right'</td>" +
                                                "</tr>");
                                    }
                                }

                                $("#tempForm").append("<form action'#' id='" + i + "'>");
                            }
                        }
                    }
                    separateRadio();
                    computeVatItem();
                    reorderItems();
                    $('.shade').fadeOut();
                }
                , error: function(response) {
                    console.debug(response);
                    $('.shade').fadeOut();
                }
            });
        });

        $("#importrfselect2").change(function(){
            if($(this).val() != ''){
                importrfpreview = $("#importrfpreview tbody tr td");
                importrfpreview.eq(0).text($(this).children('option:selected').data('refnum'));
                importrfpreview.eq(1).text($(this).children('option:selected').data('urgency'));
                importrfpreview.eq(2).text($(this).children('option:selected').data('approver'));
                importrfpreview.eq(3).text($(this).children('option:selected').data('dateneeded'));

                $("#importconfirm").prop('disabled', false);
            }
            else{
                $("#importconfirm").prop('disabled', true);
            }
        });

        $(document).ready(function() {
            $("#importrfselect2").select2({
                dropdownParent: $("#myModal")
            });
        });

        $(document).on('click', '.removeprf', function(){
            $('.shade').fadeIn();
            var e = $(this);

            $.ajax({
                url: "{% url 'canvasssheet:removeprf' %}",
                type: "post",
                data: {'prfnum': $(this).data('prf'),
                        'secretkey': $("#id_secretkey").val()
                },

                success: function(response) {
                    reorderItems();
                    e.parent().remove();
                    $('.shade').fadeOut();
                }
                , error: function(response) {
                    console.debug(response);
                    $('.shade').fadeOut();
                }
            });
        });

        $(document).on('change', '.supplier', function(){
            computeVatSummary();
        });

        $(document).on('change', '.item_cost, .item_quantity_input', function(){
            computeVatItem();
        });

        $(document).on('click', '#importbutton', function(){
            $('#importrfselect2').find('option').prop( "disabled", false );
            $('.removeprf').each(function(index){
                $('#importrfselect2').find('option[data-refnum=' + $(this).data('prf') + ']').prop( "disabled", true );
                $('#importrfselect2').select2("destroy");
                $('#importrfselect2').select2();

            });
            resetPrfOptions();
        });

        $('#validateButton').click(function(){
            $('.shade').fadeIn();
            updateTempItems();
        });

        function updateTempItems(){
            var arr_item_list = new Array();
            var arr_quantity_item = new Array();
            var arr_item_quantity_input = new Array();
            var arr_checked_supplier = new Array();
            var arr_checked_supplier_item = new Array();
            var arr_item_cost_supplier = new Array();
            var arr_item_cost_item = new Array();
            var arr_item_cost = new Array();

            // get item list
            $('.item_container').each(function(){
                arr_item_list.push($(this).attr('id'));
            });

            // get quantity input per item
            $('.item_quantity_input').each(function(index){
                arr_quantity_item.push($(this).data('item'));
                arr_item_quantity_input.push($(this).val());
            });

            // get supplier selected per item
            $('.supplier:checked').each(function(index){
                arr_checked_supplier.push($(this).data('supplier'));
                arr_checked_supplier_item.push($(this).data('item'));
            });

            // get nego cost per supplier
            $('.item_cost').each(function(index){
                arr_item_cost_supplier.push($(this).parent().parent().find('.supplier').data('supplier'));
                arr_item_cost_item.push($(this).parent().parent().find('.supplier').data('item'));
                arr_item_cost.push($(this).val());
            });

            $.ajax({
                url: "{% url 'canvasssheet:updatecsdetailtemp' %}",
                type: "post",
                data: {'prfnum': $("#importrfselect2").val(),
                        'arr_item_list[]': arr_item_list,
                        'arr_quantity_item[]': arr_quantity_item,
                        'arr_checked_supplier[]': arr_checked_supplier,
                        'arr_checked_supplier_item[]': arr_checked_supplier_item,
                        'arr_item_quantity_input[]': arr_item_quantity_input,
                        'arr_item_cost_supplier[]': arr_item_cost_supplier,
                        'arr_item_cost_item[]': arr_item_cost_item,
                        'arr_item_cost[]': arr_item_cost,
                        'secretkey': $("#id_secretkey").val()
                },

                success: function(response) {
                    $('#form-b').submit();
                    $('.shade').fadeOut();
                }
                , error: function(response) {
                    console.debug(response);
                    $('.shade').fadeOut();
                }
            });
        }

        function resetPrfOptions(){
            $('#importrfselect2').val('').trigger('change');
            $('#importrfpreview td').html(" - ");

            $("#importrfselect2").select2({
                dropdownParent: $("#myModal")
            });
        }

        function reorderItems(){
            len = summary.find('tr.item_container').find('td:eq(0)').length;
            for(i=0;i<len;i++){
                summary.find('tr.item_container:eq('+i+')').find('td:eq(0)').html(i+1);
            }
        }

        function filterSupplier(item, supplier){
            return $.grep(supplier, function(data){
                return data[0] == item;
            });
        }

        function computeVatItem(){
            $(".item_amount").each(function(index) {
                if($(this).parent().attr('class') == "item_container"){
                    item_total = parseInt($(this).siblings('.item_quantity').find('.item_quantity_input').val());
                }
                else{
                    item_total = $(this).parent().prevAll('.item_container:first').find('.item_quantity').find('.item_quantity_input').val();
                }

                item_total_amount = (item_total * parseFloat($(this).prev().find('.item_cost').val()));
                item_vat_rate = parseFloat($(this).siblings('.item_vat_rate').html());
                item_gross_amount = item_total_amount;
                item_vatcode = $(this).siblings('.item_vat_rate').data('vatcode');
                item_vatable = 0;
                item_vatexempt = 0;
                item_vatzero = 0;
                if(item_vat_rate > 0){
                    item_gross_amount = item_total_amount/(1+(item_vat_rate/100));
                    item_vatable = item_gross_amount;
                }
                else{
                    if(item_vatcode == 'VE'){
                        item_vatexempt = item_gross_amount;
                    }
                    else if(item_vatcode == 'ZE'){
                        item_vatzero = item_gross_amount;
                    }
                }
                item_totalpurchase = item_gross_amount;
                item_addvat = item_total_amount - item_gross_amount;

                // item total amount
                $(this).siblings('.item_total_amount').html(item_total_amount.toFixed(2));
                // item vatable
                $(this).siblings('.item_vatable').html(item_vatable.toFixed(2));
                // item vatexempt
                $(this).siblings('.item_vatexempt').html(item_vatexempt.toFixed(2));
                // item vatzero
                $(this).siblings('.item_vatzero').html(item_vatzero.toFixed(2));
                // item totalpurchase
                $(this).siblings('.item_totalpurchase').html(item_totalpurchase.toFixed(2));
                // item addvat
                $(this).siblings('.item_addvat').html(item_addvat.toFixed(2));
                // item gross amount
                $(this).html(item_gross_amount.toFixed(2));
            });
            computeVatSummary();
        }

        function computeVatSummary(){
            totalQty = 0;
            grossAmt = 0;
            vatAble = 0;
            vatExempt = 0;
            vatZero = 0;
            totalPurchase = 0;
            addVat = 0;
            totalAmt = 0;

            $('.item_quantity_input').each(function(){
                //compute
                totalQty += parseFloat($(this).val());
            });

            $('.supplier:checked').each(function(){
                //compute
                grossAmt += parseFloat($(this).parent().siblings('.item_amount').html());
                vatAble += parseFloat($(this).parent().siblings('.item_vatable').html());
                vatExempt += parseFloat($(this).parent().siblings('.item_vatexempt').html());
                vatZero += parseFloat($(this).parent().siblings('.item_vatzero').html());
                totalPurchase += parseFloat($(this).parent().siblings('.item_totalpurchase').html());
                addVat += parseFloat($(this).parent().siblings('.item_addvat').html());
                totalAmt += parseFloat($(this).parent().siblings('.item_total_amount').html());

            });
            //apply
            $('#totalQty').val(totalQty.toFixed(2));
            $('#grossAmt').val(grossAmt.toFixed(2));
            $('#vatAble').val(vatAble.toFixed(2));
            $('#vatExempt').val(vatExempt.toFixed(2));
            $('#vatZero').val(vatZero.toFixed(2));
            $('#totalPurchase').val(totalPurchase.toFixed(2));
            $('#addVat').val(addVat.toFixed(2));
            $('#totalAmt').val(totalAmt.toFixed(2));

        }

        function separateRadio(){
            i = 0;

            $('.item_container').each(function(){

                currentElement = $(this);

                $(this).find('.supplier').attr('form', i);
                $(this).find('.supplier').attr('form', i).attr('checked', 'checked');

                while(currentElement.next().not('.item_container').length == 1){
                    currentElement.next().find('.supplier').attr('form', i);
                    currentElement = currentElement.next();
                }

                i++;
            });
        }
    });
</script>