{% extends 'base-form.html' %}
{% load staticfiles %}
{% load mathfilters %}
{% load humanize %}
{% block page-title %} Posting of Transactions {% endblock page-title %}
{% block extra_css %}
    <link rel="stylesheet" href="{% static 'financial-layout/assets/plugin/select2/css/select2.css' %}" />
    <link rel="stylesheet" href="{% static 'financial-layout/assets/plugin/bootstrap-datepicker/css/bootstrap-datepicker.min.css' %}" />
    <style>
{#        .iconlist {#}
{#            text-align: left;#}
{#            margin-left: 40px;#}
{#            margin-right: 40px;#}
{#        }#}
        .btns-icon{
            padding: 2px;
            margin: auto;
        }
        td{
            vertical-align: middle !important;
        }
        .checkbox label {
            padding-left: 5px;
        }
        .input-sm{
            font-size: 13px !important;
        }
        .price-list{
            background-color: white;
        }
        .price-list .price-price{
            font-size: 14px !important;
            text-align: left;
            color: #76838f !important;
        }
        .price-title.bg-teal-a400:before {
            background: #00bfa5;
        }
        .price-list .price-title{
            padding-top: 5px;
            letter-spacing: 1px;
        }
        .price-title:before {
            position: relative;
            display: block;
            width: 14px;
            height: 14px;
            content: '';
            top: 42px;
            transform: rotate(45deg);
            text-align: center;
            margin-right: auto;
            margin-left: auto;
        }
        .price-footer{
            margin-top: 40px;
        }
        .fa-spin {
          -webkit-animation: fa-spin 0.5s infinite linear;
          animation: fa-spin 0.5s infinite linear;
        }
        @-webkit-keyframes fa-spin {
          0% {
            -webkit-transform: rotate(0deg);
            transform: rotate(0deg);
          }
          100% {
            -webkit-transform: rotate(359deg);
            transform: rotate(359deg);
          }
        }
        @keyframes fa-spin {
          0% {
            -webkit-transform: rotate(0deg);
            transform: rotate(0deg);
          }
          100% {
            -webkit-transform: rotate(359deg);
            transform: rotate(359deg);
          }
        }
        .white{
            background-color: white !important;
            color: #76838f !important;
        }
        .sp-series{
            font-size: 20px;
        }
        .spinner-2{
            vertical-align: middle;
            font-size: 25px !important;
            margin-left: 11px;
            margin-top: -1px;
        }
        .sp-title{
            font-size: 17px;
        }
        .tr_transition{
            display: none;
            position: absolute;
            margin: auto;
            left: 0;
            right: 0;
        }
        .tr_wait{
            display: block;
        }
        .tr_content > p{
            text-align: left;
        }
    </style>
{% endblock extra_css %}
{% block page-content %}
{% block content %}
<div id="trans_step_verify">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <div class="page-wrap">
                    <div class="col-md-12">
                        <div class="price-list margin-sm-0">
                            <div class="price-header">
                                <div class="price-title bg-teal-a400">STEP 1: VERIFICATION</div>
                                <div class="price-price teal-a400" id="formupload">
                                    <div class="col-md-6 select_holder" id="datefrom_holder">
                                        <label class="control-label small" for="id_datefrom">Date FROM:</label>
                                        <input type="text" class="form-control date-yyyymmdd datepickerfrom white" readonly="readonly"
                                               style="padding: 5px 10px" id="id_datefrom" name="datefrom" placeholder="YYYY-MM-DD"
                                               value="{{ datefrom }}">
                                        <br><br>
                                    </div>
                                    <div class="col-md-6 select_holder" id="dateto_holder">
                                        <label class="control-label small" for="id_dateto">Date TO:</label>
                                        <input type="text" class="form-control date-yyyymmdd datepickerto white" readonly="readonly"
                                               style="padding: 5px 10px" id="id_dateto" name="dateto" placeholder="YYYY-MM-DD"
                                               value="{{ dateto }}">
                                        <br><br>
                                    </div>
                                </div>
                            </div>
                            <div class="price-footer">
                                <button type="button" class="btn btn-info waves-effect waves-light" id="trans_verify">
                                    <i class="icon fa-exchange font-16 margin-right-10" aria-hidden="true" style="vertical-align: middle"></i>
                                    Verify
                                </button>
                                <button type="button" disabled="disabled" class="btn btn-info" style="display: none;" id="or_upload_loading">
                                    <i class="icon fa-spinner fa-spin font-16 margin-right-10" aria-hidden="true" style="vertical-align: middle"></i>
                                    VERIFYING ...
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="clearfix"></div>
        </div>
    </div>
</div>
<br><br>
<div id="trans_step_post">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <div class="page-wrap">
                    <div class="col-md-12">
                        <div class="price-list margin-sm-0">
                            <div class="price-header">
                                <div class="price-title bg-teal-a400">STEP 2: FINALIZE AND POST</div>
                                <div class="price-price teal-a400" id="formupload">
                                    <div class="col-md-12 ">
                                        <div class="page-wrap" style="margin-bottom: 30px;">
                                            <div class="row traingle">
                                                <div class="col-md-3 col-sm-6 col-xs-12" id="trans_ap">
                                                    <div class="step-box">
                                                        <span class="sp-series gray-back tr_transition tr_wait">
                                                            <i class="icon fa-book font-16 margin-right-10 spinner-2" aria-hidden="true" style="vertical-align: middle"></i>
                                                        </span>
                                                        <span class="sp-series info-back tr_transition tr_load">
                                                            <span><i class="icon fa-circle-o-notch fa-spin font-16 margin-right-10 spinner-2" aria-hidden="true" style="vertical-align: middle"></i></span>
                                                        </span>
                                                        <span class="sp-series gray-back tr_transition tr_failed">
                                                            <i class="icon fa-close font-16 margin-right-10 spinner-2" aria-hidden="true" style="vertical-align: middle"></i>
                                                        </span>
                                                        <span class="sp-series info-back tr_transition tr_success">
                                                            <span><i class="icon fa-check  font-16 margin-right-10 spinner-2" aria-hidden="true" style="vertical-align: middle"></i></span>
                                                        </span>
                                                        <span class="sp-series" style="visibility: hidden; border: 4px transparent;"></span>
                                                        <div class="sp-circle step-col gray-back tr_content">
                                                            <span class="sp-title">Accounts Payable</span><br><br>
                                                            <p>
                                                                Items checked: <span class="text-warning item_count">-</span><br>
                                                                Elapsed: <span class="text-warning elapsed_count">-</span>
                                                            </p>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-3 col-sm-6 col-xs-12" id="trans_cv">
                                                    <div class="step-box">
                                                        <span class="sp-series gray-back tr_transition tr_wait">
                                                            <i class="icon fa-book font-16 margin-right-10 spinner-2" aria-hidden="true" style="vertical-align: middle"></i>
                                                        </span>
                                                        <span class="sp-series info-back tr_transition tr_load">
                                                            <span><i class="icon fa-circle-o-notch fa-spin font-16 margin-right-10 spinner-2" aria-hidden="true" style="vertical-align: middle"></i></span>
                                                        </span>
                                                        <span class="sp-series gray-back tr_transition tr_failed">
                                                            <i class="icon fa-close font-16 margin-right-10 spinner-2" aria-hidden="true" style="vertical-align: middle"></i>
                                                        </span>
                                                        <span class="sp-series info-back tr_transition tr_success">
                                                            <span><i class="icon fa-check  font-16 margin-right-10 spinner-2" aria-hidden="true" style="vertical-align: middle"></i></span>
                                                        </span>
                                                        <span class="sp-series" style="visibility: hidden; border: 4px transparent;"></span>
                                                        <div class="sp-circle step-col gray-back tr_content">
                                                            <span class="sp-title">Check Voucher</span><br><br>
                                                            <p>
                                                                Items checked: <span class="text-warning item_count">-</span><br>
                                                                Elapsed: <span class="text-warning elapsed_count">-</span>
                                                            </p>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-3 col-sm-6 col-xs-12" id="trans_jv">
                                                    <div class="step-box">
                                                        <span class="sp-series gray-back tr_transition tr_wait">
                                                            <i class="icon fa-book font-16 margin-right-10 spinner-2" aria-hidden="true" style="vertical-align: middle"></i>
                                                        </span>
                                                        <span class="sp-series info-back tr_transition tr_load">
                                                            <span><i class="icon fa-circle-o-notch fa-spin font-16 margin-right-10 spinner-2" aria-hidden="true" style="vertical-align: middle"></i></span>
                                                        </span>
                                                        <span class="sp-series gray-back tr_transition tr_failed">
                                                            <i class="icon fa-close font-16 margin-right-10 spinner-2" aria-hidden="true" style="vertical-align: middle"></i>
                                                        </span>
                                                        <span class="sp-series info-back tr_transition tr_success">
                                                            <span><i class="icon fa-check  font-16 margin-right-10 spinner-2" aria-hidden="true" style="vertical-align: middle"></i></span>
                                                        </span>
                                                        <span class="sp-series" style="visibility: hidden; border: 4px transparent;"></span>
                                                        <div class="sp-circle step-col gray-back tr_content">
                                                            <span class="sp-title">Journal Voucher</span><br><br>
                                                            <p>
                                                                Items checked: <span class="text-warning item_count">-</span><br>
                                                                Elapsed: <span class="text-warning elapsed_count">-</span>
                                                            </p>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-md-3 col-sm-6 col-xs-12" id="trans_or">
                                                    <div class="step-box">
                                                        <span class="sp-series gray-back tr_transition tr_wait">
                                                            <i class="icon fa-book font-16 margin-right-10 spinner-2" aria-hidden="true" style="vertical-align: middle"></i>
                                                        </span>
                                                        <span class="sp-series info-back tr_transition tr_load">
                                                            <span><i class="icon fa-circle-o-notch fa-spin font-16 margin-right-10 spinner-2" aria-hidden="true" style="vertical-align: middle"></i></span>
                                                        </span>
                                                        <span class="sp-series gray-back tr_transition tr_failed">
                                                            <i class="icon fa-close font-16 margin-right-10 spinner-2" aria-hidden="true" style="vertical-align: middle"></i>
                                                        </span>
                                                        <span class="sp-series info-back tr_transition tr_success">
                                                            <span><i class="icon fa-check  font-16 margin-right-10 spinner-2" aria-hidden="true" style="vertical-align: middle"></i></span>
                                                        </span>
                                                        <span class="sp-series" style="visibility: hidden; border: 4px transparent;"></span>
                                                        <div class="sp-circle step-col gray-back tr_content">
                                                            <span class="sp-title">Official Receipt</span><br><br>
                                                            <p>
                                                                Items checked: <span class="text-warning item_count">-</span><br>
                                                                Elapsed: <span class="text-warning elapsed_count">-</span>
                                                            </p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="price-footer">
                                <button type="button" class="btn btn-info waves-effect waves-light" id="trans_post">
                                    <i class="icon fa-check-square-o font-16 margin-right-10" aria-hidden="true" style="vertical-align: middle"></i>
                                    Post
                                </button>
                                <button type="button" disabled="disabled" class="btn btn-info" style="display: none;" id="or_upload_loading">
                                    <i class="icon fa-spinner fa-spin font-16 margin-right-10" aria-hidden="true" style="vertical-align: middle"></i>
                                    VERIFYING ...
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="clearfix"></div>
        </div>
    </div>
</div>
<br><br>
<div id="trans_step_final">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <div class="page-wrap">
                    <div class="col-md-12">
                        <div class="price-list margin-sm-0">
                            <div class="price-header">
                                <div class="price-title bg-teal-a400">STEP 3: POSTING RESULTS</div>
                                <div class="price-price teal-a400" id="formupload">
                                    <div class="col-md-12 ">
                                        <br><br>
                                        <div class="animatebar clearfix">
                                            <div class="animatebar-bar progress-bar-info"></div>
                                            <div class="animatebar-bar-percent"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="price-footer">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="clearfix"></div>
        </div>
    </div>
</div>
<br><br><br>
<input type="hidden" id="batchkey">
{% endblock %}
{% endblock page-content %}
{% block extra_js %}
    {% load staticfiles %}
    <script src="{% static 'financial-layout/assets/plugin/bootstrap-datepicker/js/bootstrap-datepicker.min.js' %}"></script>
    <script src="{% static 'financial-layout/assets/plugin/bootstrap-datepicker/js/custom-datepicker.js' %}"></script>
    <script src="{% static 'js/jquery.maskMoney.min.js' %}" type="text/javascript"></script>
    <script src="{% static 'js/custom-maskMoney.js' %}" type="text/javascript"></script>
    <script src="{% static 'financial-layout/assets/plugin/select2/js/select2.min.js' %}"></script>
    <script src="{% static 'js/ajaxselect2.js' %}" type="text/javascript"></script>
    <script>
    $(function () {
        $(document).on('click', '#trans_verify', function(){
            $('#trans_ap').find('.tr_transition').hide();
            $('#trans_ap').find('.tr_content').removeClass('gray-back').addClass('info-back');
            $('#trans_ap').find('.tr_load').show();

            $.ajax({
                url: "{% url 'transactionposting:verifytransactions' %}",
                type: "post",
                dataType: "json",
                start_time: new Date().getTime(),
                data: {
                    'csrfmiddlewaretoken': "{{csrf_token}}",
                    'type': "ap"
                },
                success: function(response) {
                    //--------------- ACCOUNTS PAYABLE ---------------
                    //--------------- ACCOUNTS PAYABLE ---------------
                    //--------------- ACCOUNTS PAYABLE ---------------
                    reply = response.response;
                    item_count = response.item_count;

                    $('#trans_ap').find('.tr_transition').hide();

                    if(reply == 'success'){
                        var tr_content = $('#trans_ap').find('.tr_content').find('p');
                        $('#trans_ap').find('.tr_success').show();
                        tr_content.find('.item_count').html(item_count);
                        tr_content.find('.elapsed_count').html(((new Date().getTime() - this.start_time) / 1000).toFixed(1) + " sec");
                    }
                    else{
                        $('#trans_ap').find('.tr_failed').show();
                        $('#trans_ap').find('.tr_content').removeClass('info-back').addClass('gray-back');
                    }
                    $('#trans_cv').find('.tr_transition').hide();
                    $('#trans_cv').find('.tr_content').removeClass('gray-back').addClass('info-back');
                    $('#trans_cv').find('.tr_load').show();

                    $('#batchkey').val(response.batchkey);

                    $.ajax({
                        url: "{% url 'transactionposting:verifytransactions' %}",
                        type: "post",
                        dataType: "json",
                        start_time: new Date().getTime(),
                        data: {
                            'csrfmiddlewaretoken': "{{csrf_token}}",
                            'type': "cv",
                            'batchkey': $('#batchkey').val()
                        },
                        success: function(response) {
                            //--------------- CHECK VOUCHER ---------------
                            //--------------- CHECK VOUCHER ---------------
                            //--------------- CHECK VOUCHER ---------------
                            reply = response.response;
                            item_count = response.item_count;

                            $('#trans_cv').find('.tr_transition').hide();
                            if(reply == 'success'){
                                var tr_content = $('#trans_cv').find('.tr_content').find('p');
                                $('#trans_cv').find('.tr_success').show();
                                tr_content.find('.item_count').html(item_count);
                                tr_content.find('.elapsed_count').html(((new Date().getTime() - this.start_time) / 1000).toFixed(1) + " sec");
                            }
                            else{
                                $('#trans_cv').find('.tr_failed').show();
                                $('#trans_cv').find('.tr_content').removeClass('info-back').addClass('gray-back');
                            }
                            $('#trans_jv').find('.tr_transition').hide();
                            $('#trans_jv').find('.tr_content').removeClass('gray-back').addClass('info-back');
                            $('#trans_jv').find('.tr_load').show();

                            $.ajax({
                                url: "{% url 'transactionposting:verifytransactions' %}",
                                type: "post",
                                dataType: "json",
                                start_time: new Date().getTime(),
                                data: {
                                    'csrfmiddlewaretoken': "{{csrf_token}}",
                                    'type': "jv",
                                    'batchkey': $('#batchkey').val()
                                },
                                success: function(response) {
                                    //--------------- JOURNAL VOUCHER ---------------
                                    //--------------- JOURNAL VOUCHER ---------------
                                    //--------------- JOURNAL VOUCHER ---------------
                                    reply = response.response;
                                    item_count = response.item_count;

                                    $('#trans_jv').find('.tr_transition').hide();
                                    if(reply == 'success'){
                                        var tr_content = $('#trans_jv').find('.tr_content').find('p');
                                        $('#trans_jv').find('.tr_success').show();
                                        tr_content.find('.item_count').html(item_count);
                                        tr_content.find('.elapsed_count').html(((new Date().getTime() - this.start_time) / 1000).toFixed(1) + " sec");
                                    }
                                    else{
                                        $('#trans_jv').find('.tr_failed').show();
                                        $('#trans_jv').find('.tr_content').removeClass('info-back').addClass('gray-back');
                                    }
                                    $('#trans_or').find('.tr_transition').hide();
                                    $('#trans_or').find('.tr_content').removeClass('gray-back').addClass('info-back');
                                    $('#trans_or').find('.tr_load').show();

                                    $.ajax({
                                        url: "{% url 'transactionposting:verifytransactions' %}",
                                        type: "post",
                                        dataType: "json",
                                        start_time: new Date().getTime(),
                                        data: {
                                            'csrfmiddlewaretoken': "{{csrf_token}}",
                                            'type': "or",
                                            'batchkey': $('#batchkey').val()
                                        },
                                        success: function(response) {
                                            //--------------- OFFICIAL RECEIPT ---------------
                                            //--------------- OFFICIAL RECEIPT ---------------
                                            //--------------- OFFICIAL RECEIPT ---------------
                                            reply = response.response;
                                            item_count = response.item_count;

                                            $('#trans_or').find('.tr_transition').hide();
                                            if(reply == 'success'){
                                                var tr_content = $('#trans_or').find('.tr_content').find('p');
                                                $('#trans_or').find('.tr_success').show();
                                                tr_content.find('.item_count').html(item_count);
                                                tr_content.find('.elapsed_count').html(((new Date().getTime() - this.start_time) / 1000).toFixed(1) + " sec");
                                            }
                                            else{
                                                $('#trans_or').find('.tr_failed').show();
                                                $('#trans_or').find('.tr_content').removeClass('info-back').addClass('gray-back');
                                            }
                                        }
                                    });
                                }
                            });
                        }
                    });




{#                        subgroup = response.subgroup;#}
{#    #}
{#                        $('#rep_f_subgroup').html('');#}
{#                        for(i=0;i<subgroup.length;i++){#}
{#                            $('#rep_f_subgroup').prepend("<option value='"+subgroup[i][0]+"' label='"+subgroup[i][1]+"'>"+subgroup[i][1]+" - "+subgroup[i][2]+"</option>")#}
{#                        }#}
{#                        $('#rep_f_subgroup').select2("destroy").select2({#}
{#                            templateSelection: function(item) {#}
{#                                return $(item.element).attr('label');#}
{#                            }#}
{#                        });#}
                }
            });
        });

        $(document).on('click', '#trans_post', function(){
            posting(0);
        });

        function posting(sequence){
            $.ajax({
                url: "{% url 'transactionposting:posttransactions' %}",
                type: "post",
                dataType: "json",
                start_time: new Date().getTime(),
                data: {
                    'csrfmiddlewaretoken': "{{csrf_token}}",
                    'batchkey': $('#batchkey').val(),
                    'sequence': sequence
                },
                success: function(response) {
                    $('.animatebar-bar').css({'width': response.percentage + '%'});
                    $('.animatebar-bar-percent').html(response.percentage + '%');
                    console.log(response.sequence)
                    console.log(response.total)
                    if(response.sequence < response.total){
                        posting(response.sequence);
                    }
                }
            });
        }
	});
    </script>
{% endblock extra_js %}
